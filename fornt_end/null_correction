import pandas as pd
import networkx as nx
import json
import math
from networkx.readwrite import json_graph

# --- DOSYA YOLUNU TEKRAR BURAYA YAPIÅTIR ---
dosya_yolu = r"data/processed/istanbul_graph.pkl" 
# -------------------------------------------

def clean_nan(obj):
    """
    Verinin iÃ§indeki NaN (Bozuk sayÄ±) deÄŸerlerini null yapar.
    """
    if isinstance(obj, float):
        if math.isnan(obj) or math.isinf(obj):
            return None  # NaN ise null yap
    elif isinstance(obj, dict):
        return {k: clean_nan(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [clean_nan(v) for v in obj]
    return obj

try:
    print(f"Dosya okunuyor: {dosya_yolu}")
    data = pd.read_pickle(dosya_yolu)
    
    cikti_adi = "veri.json"
    json_data = {}

    # EÄŸer veri NetworkX Graph ise
    if isinstance(data, (nx.Graph, nx.DiGraph, nx.MultiDiGraph)):
        json_data = json_graph.node_link_data(data)
        print("âœ… Veri Graph formatÄ±nda alÄ±ndÄ±.")
    else:
        # DeÄŸilse dÃ¼z Ã§evirmeyi dene
        print("âš ï¸ Veri Graph deÄŸil, dÃ¼z Ã§evriliyor.")
        # BurasÄ± basit senaryo, ama senin verin Graph olduÄŸu iÃ§in Ã¼stteki Ã§alÄ±ÅŸacak.

    # TEMÄ°ZLÄ°K ZAMANI: NaN deÄŸerlerini temizle
    print("ğŸ§¹ Veri temizleniyor (NaN temizliÄŸi)...")
    cleaned_data = clean_nan(json_data)

    # DosyayÄ± kaydet
    with open(cikti_adi, "w", encoding="utf-8") as f:
        json.dump(cleaned_data, f, ensure_ascii=False)

    print(f"âœ… Ä°ÅLEM TAMAM! Yeni '{cikti_adi}' dosyasÄ± oluÅŸturuldu.")
    print("ğŸ‘‰ Åimdi bu yeni veri.json dosyasÄ±nÄ± alÄ±p src klasÃ¶rÃ¼ne at!")

except Exception as e:
    print(f"âŒ HATA: {e}")